name: Node.js CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  # 1. Unit Tests
  unit-test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    - uses: actions/setup-node@v3
      with:
        node-version: '20.x'
        cache: 'npm'
    - run: npm ci
    - run: npm test

  # 2. SAST Scan (Dependency Check)
  sast-scan:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    - uses: actions/setup-node@v3
      with:
        node-version: '20.x'
        cache: 'npm'
    - run: npm ci
    - run: npm audit --audit-level=high || true

  # 3. DAST Scan (OWASP ZAP)
  dast-scan:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    - name: Build Local Image
      run: docker build -t local-test-image .
    - name: Run Container
      run: |
        docker run -d -p 3000:3000 --name test-container local-test-image
        sleep 5
    - name: Run ZAP Scan
      uses: zaproxy/action-baseline@v0.14.0
      with:
        target: 'http://localhost:3000/health'
        fail_action: false
        allow_issue_writing: false
        artifact_name: 'zap-scan'

  # 4. Deploy (Push to Hub)
  deploy:
    needs: [unit-test, sast-scan, dast-scan]
    runs-on: ubuntu-latest
    if: github.event_name != 'pull_request'
    steps:
    - uses: actions/checkout@v3
    - uses: docker/setup-buildx-action@v2
    - uses: docker/login-action@v2
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}
    - uses: docker/build-push-action@v4
      with:
        context: .
        push: true
        tags: ${{ secrets.DOCKER_USERNAME }}/student-registry:latest
